# Руководство разработчика

## Быстрый старт

### 1. Клонирование репозитория
```bash
git clone <repository-url>
cd ai-mediator
```

### 2. Настройка окружения

**Выберите способ установки:**

#### Простой способ (быстрый старт)
```bash
make setup
```

#### Разработческий режим (с дополнительными инструментами)
```bash
make dev-install
```

### 3. Настройка переменных окружения
```bash
# Файл .env создается автоматически из .env.example
# Отредактируйте его с вашими токенами:
nano .env
```

**Обязательные переменные:**
- `TELEGRAM_BOT_TOKEN` - получить у [@BotFather](https://t.me/BotFather)
- `TELEGRAM_BOT_USERNAME` - имя вашего бота
- `OPENAI_API_KEY` - получить на [platform.openai.com](https://platform.openai.com/)
- `DATABASE_URL` - по умолчанию использует SQLite
- `LOG_LEVEL` - уровень логирования (INFO, DEBUG, ERROR)

### 4. Запуск приложения

```bash
# Запуск бота
make start

# Проверка конфигурации
make check-env
```


## Разработка

### Основные команды

```bash
# Установка и настройка
make install              # Установка зависимостей
make dev-install         # Установка с dev-зависимостями
make setup               # Полная настройка

# Запуск и проверка
make start               # Запуск бота
make check-env          # Проверка конфигурации

# Очистка
make clean              # Очистить временные файлы
make clean-venv         # Удалить виртуальное окружение
make reset              # Полный сброс

# Справка
make help               # Показать все доступные команды
```

### Структура кода

#### Точка входа (`src/main.py`)
```python
# Основная точка входа для Telegram бота
# Инициализирует все компоненты и запускает бота
```

#### Конфигурация (`src/config/`)
```python
# settings.py - загрузка настроек из переменных окружения
# Использует pydantic-settings для типизированной конфигурации
```

#### Доменный слой (`src/domain/`)
```python
# entities.py - основные бизнес-сущности:
# - DialogSession - сессия медиации между двумя пользователями
# - Message - сообщение в диалоге
# - User - пользователь системы
```

#### Сервисный слой (`src/service/`)
```python
# session_service.py - основная бизнес-логика:
# - Создание сессий медиации
# - Управление приглашениями
# - Обработка сообщений
```

#### Репозиторий (`src/repository/`)
```python
# interface.py - определяет контракты для работы с данными
# mock_repository.py - временная реализация в памяти для разработки
```

#### Транспорт (`src/transport/telegram/`)
```python
# handlers.py - обработчики Telegram команд:
# - /start - создание новой сессии
# - /invite - генерация ссылки-приглашения
# - Обработка текстовых сообщений
```

### Принципы разработки

1. **Clean Architecture** - четкое разделение ответственностей между слоями
2. **Dependency Injection** - зависимости передаются через интерфейсы
3. **Single Responsibility** - каждый модуль решает одну задачу
4. **Типизация** - используем type hints везде
5. **Async/await** - асинхронная обработка для производительности

### Добавление нового функционала

#### Новая команда бота
1. Добавьте обработчик в `src/transport/telegram/handlers.py`
2. Если нужна бизнес-логика, добавьте методы в соответствующий сервис
3. Для работы с данными используйте репозитории

#### Новая бизнес-сущность
1. Добавьте класс в `src/domain/entities.py`
2. Создайте интерфейс репозитория в `src/repository/interface.py`
3. Реализуйте заглушку в `src/repository/mock_repository.py`

#### Новый внешний сервис
1. Создайте модуль в `src/external_services/`
2. Определите интерфейс для внедрения зависимостей
3. Добавьте конфигурацию в `src/config/settings.py`

### Отладка

#### Локальная разработка
```bash
# Запуск с подробными логами
LOG_LEVEL=DEBUG make start

# Проверка импортов
python -c "from src.main import main; print('OK')"

# Тестирование конфигурации
make check-env
```

#### Логирование
Все логи выводятся в структурированном формате с указанием:
- Временной метки
- Уровня логирования
- Модуля
- Сообщения

#### Частые проблемы

**1. Проблемы с импортами**
```bash
# Убедитесь, что запускаете из корня проекта
python -m src.main
```

**2. Проблемы с зависимостями**
```bash
# Переустановите окружение
make reset
make setup
```

**3. Проблемы с токенами**
```bash
# Проверьте файл .env
cat .env
make check-env
```

## Docker разработка

### Локальная разработка с Docker
```bash
# Сборка и запуск
make docker-build
make docker-up

# Логи
make docker-logs

# Остановка
make docker-down
```

## Тестирование

В настоящее время тестирование находится в стадии настройки. Планируется:

- Unit тесты для сервисов
- Интеграционные тесты для репозиториев  
- E2E тесты для Telegram handlers

## Workflow

### Создание новой фичи
```bash
# 1. Создайте ветку
git checkout -b feature/новая-фича

# 2. Разработка
make dev-install
make start

# 3. Тестирование (когда будет готово)
make test
make lint

# 4. Коммит и push
git add .
git commit -m "feat: добавил новую фичу"
git push origin feature/новая-фича
```

### Стандарты коммитов
```
feat: новая функциональность
fix: исправление бага
docs: обновление документации
refactor: рефакторинг без изменения функциональности
test: добавление или обновление тестов
```

## Производственное развертывание

Планируется добавить инструкции по:
- Развертыванию в production
- CI/CD пайплайнам
- Мониторингу и логированию
- Резервному копированию данных